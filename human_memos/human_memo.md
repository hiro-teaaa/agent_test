# rules for ai
```
- Always respond in japanese
- show your thinking using <thinking></thinking>

-  if you working as agent check<agent_instructions> following integrated <task_process> step by step
- if you need or ask to create temporary file or report, use .cursor_workspace directory
```
# other
.cursorrulesを使用（やや古いが安定している実装ステップ少ない用)

# 最初の指示(claude-3.7-sonnet)
```
## 要件
日本語の住所文字列引数にとり、都道府県、市区町村、町名番地、その他の要素に分割する
住所を正規化するツールをpythonで書いて欲しい、その際TDDをに準拠した実装をして欲しい
## order
まずは @planning.md に実装ステップを書きなさい。
実装ステップは可能かぎり小さく分割し、テストもミニマムのテストをチェックしてからエッジケースなど拡張パターンを試すように実装してゆくこと

## test_detail
以下のケースは必ず含めること

1. 日本の住所を検索して代表的なテストケース
2. エッジケースをカバーするため日本の住所についてWeb検索して、網羅的テスト


```output_format
## step1
## 実装内容
<write_detail>

## test_cases
<write_case>

## 完了条件
すべてのテストがパスすること
```

はじめに日本の住所の特徴を調査した上で実装計画を作成しなさい




@Web 
```
```



## 実装完了後の修正指摘
自分で用意したexampleでめちゃくちゃ失敗していたので指摘した
```
parseに失敗しているようです
---
入力: 東京新宿区西新宿1-2-3
結果: {'prefecture': '東京都', 'city': '宿区', 'town_street': '西新宿1-2-3', 'other': ''}
---
正しくは
```
結果: {'prefecture': '東京都', 'city': '新宿区', 'town_street': '西新宿1-2-3', 'other': ''}
```
となります
この入力をtestケースに含め、失敗の原因を調査して実装の改良をしなさい
```
### output(コードとshellを除く出力)
```
<thinking>
問題点を分析します。
入力: 東京新宿区西新宿1-2-3
現在の結果: {'prefecture': '東京都', 'city': '宿区', 'town_street': '西新宿1-2-3', 'other': ''}
期待される結果: {'prefecture': '東京都', 'city': '新宿区', 'town_street': '西新宿1-2-3', 'other': ''}
問題は「東京」が「東京都」に正規化された後、残りの文字列から市区町村を抽出する際に、「新宿区」ではなく「宿区」が抽出されていることです。
これは、都道府県の省略形「東京」を「東京都」に変換した後、残りの住所文字列から正しく市区町村を抽出できていないためです。
コードを確認すると、extract_prefectureメソッドで「東京」を「東京都」に変換していますが、その後の処理で残りの住所文字列を計算する際に、元の「東京」の長さだけを除去しているため、「新」の文字が失われています。
修正すべき箇所は、parse_addressメソッド内の以下の部分です：
)
ここで、省略形の場合は元の省略形の長さを使って残りの住所を計算する必要があります。
</thinking>
問題を確認しました。「東京新宿区西新宿1-2-3」という入力で、「東京」が「東京都」に正規化された後、市区町村の抽出が正しく行われていないようです。
まず、この問題を再現するテストケースを追加し、その後コードを修正しましょう。
"
テストケースを追加しました。次に、問題の原因を調査するために、現在のコードを実行してテストが失敗することを確認しましょう。
すみません、テストファイル名が間違っていました。正しいテストファイルを実行しましょう。
予想通り、テストが失敗しました。問題は「東京」が「東京都」に正規化された後、残りの住所文字列から市区町村を抽出する際に、「新宿区」ではなく「宿区」が抽出されていることです。
これは、都道府県の省略形「東京」を「東京都」に変換した後、残りの住所文字列を計算する際に、元の「東京」の長さだけを除去しているため、「新」の文字が失われています。
コードを修正しましょう：
問題の原因が分かりました。parse_addressメソッドで、都道府県を抽出した後、残りの住所文字列を計算する際に、省略形の都道府県名（例：「東京」）が「東京都」に変換されても、元の省略形の長さ（例：「東京」の2文字）だけを除去しているため、「新」の文字が失われています。
この問題を修正するために、extract_prefectureメソッドを拡張して、元の都道府県名（省略形または完全形）も返すようにし、parse_addressメソッドでは元の都道府県名の長さを使って残りの住所を計算するようにします。
)
修正が完了しました。これで、都道府県の省略形を正しく処理できるようになりました。テストを実行して確認しましょう。
素晴らしい！テストが成功しました。次に、すべてのテストを実行して、他の機能に影響がないことを確認しましょう。
extract_prefectureメソッドの戻り値を変更したため、既存のテストが失敗しています。テストを修正しましょう。
テストを修正しました。再度すべてのテストを実行して確認しましょう。
素晴らしい！すべてのテストが成功しました。最後に、修正した問題が実際に解決されたことを確認するために、例を実行してみましょう。
問題が解決されました！「東京新宿区西新宿1-2-3」という入力に対して、正しく「新宿区」が抽出されるようになりました。
修正内容のまとめ
問題点:
都道府県の省略形（例：「東京」）を正規化された形式（例：「東京都」）に変換した後、残りの住所文字列を計算する際に、元の省略形の長さだけを除去していたため、「新」の文字が失われていました。
解決策:
extract_prefectureメソッドを修正して、正規化された都道府県名と元の都道府県名の両方を返すようにしました。
parse_addressメソッドでは、元の都道府県名の長さを使って残りの住所文字列を計算するようにしました。
テスト:
省略形の都道府県名を含む住所の解析テストケースを追加しました。
extract_prefectureメソッドの戻り値が変更されたため、関連するテストを修正しました。
これにより、「東京新宿区西新宿1-2-3」のような省略形の都道府県名を含む住所も正しく解析できるようになりました。
```


# エッジケースの追加
ChatGPTを使い、特殊ケースを整理させ、それを渡した。


## prompt(新しいスレッドで行う)
```
@parser.py 
実装したparserに以下のようなケースを追加してtestしたい
planningを更新し、テストケースの追加stepをまず作成しなさい
そのあとテストファイルにケースを追加し実行、失敗した場合は一つ一つ理由を調査しなさい
テストもすべて同時に追加するのではなく、一ケースずつ増やしなさい

``` cases
<https://chatgpt.com/share/67c33382-3d10-800e-b5d5-f610cb7ca23a の出力をそのまま貼り付け>
```
```

## response
スクショ
