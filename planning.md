# 日本語住所正規化ツール実装計画

## 日本の住所の特徴

日本の住所は一般的に以下の構造を持っています：

1. **郵便番号**：オプション（例：〒123-4567）
2. **都道府県**：47都道府県のいずれか
3. **市区町村**：市、区、町、村のいずれか
4. **町名**：地域の名称
5. **番地**：数字とハイフンの組み合わせ（例：1-2-3）
6. **建物名・部屋番号**：オプション

### 特徴と課題

- 都道府県名と市区町村名が連続して書かれることが多い（例：東京都新宿区）
- 番地の表記方法が多様（1番2号、1-2-3、一丁目二番三号など）
- 建物名や部屋番号の表記も多様
- 省略形や略称が使われることがある（例：東京→東京都）
- 全角・半角の混在
- 区切り文字の有無や種類の違い

## 実装ステップ

### ステップ1: 基本構造の設計とテスト環境の構築
#### 実装内容
- プロジェクト構造の設定
  - `address_parser/` ディレクトリの作成
  - `__init__.py` ファイルの作成
  - `parser.py` ファイルの作成
  - `tests/` ディレクトリの作成
  - `tests/__init__.py` ファイルの作成
  - `tests/test_parser.py` ファイルの作成
- テスト環境の構築（pytestの設定）
  - `pytest.ini` ファイルの作成
  - `requirements.txt` ファイルの作成
- 基本的なクラス・関数の設計
  - `AddressParser` クラスの基本構造の実装
  - `parse_address` メソッドのスケルトン実装

#### テストケース
- プロジェクト構造が正しく設定されていることを確認
- `AddressParser` クラスが初期化できることを確認
- `parse_address` メソッドが呼び出せることを確認

#### 完了条件
- すべてのテストがパスすること
- プロジェクト構造が正しく設定されていること

### ステップ2: 都道府県の抽出機能実装
#### 実装内容
- 47都道府県のリストを作成
- 住所文字列から都道府県を抽出する機能の実装
  - `extract_prefecture` メソッドの実装
  - 都道府県名の正規化（例：「東京」→「東京都」）

#### テストケース
1. 標準的な都道府県表記（例：「東京都」）
2. 省略形の都道府県表記（例：「東京」）
3. 都道府県名が含まれない住所

#### 完了条件
- すべてのテストがパスすること
- 都道府県が正しく抽出されること

### ステップ3: 市区町村の抽出機能実装
#### 実装内容
- 市区町村を抽出する機能の実装
  - `extract_city` メソッドの実装
  - 市区町村名の正規化

#### テストケース
1. 標準的な市区町村表記（例：「新宿区」）
2. 特殊な市区町村表記（例：「府中市」）
3. 市区町村名が含まれない住所

#### 完了条件
- すべてのテストがパスすること
- 市区町村が正しく抽出されること

### ステップ4: 町名・番地の抽出機能実装
#### 実装内容
- 町名と番地を抽出する機能の実装
  - `extract_town_street` メソッドの実装
  - 町名と番地の分離

#### テストケース
1. 標準的な町名番地表記（例：「西新宿1-2-3」）
2. 漢字表記の番地（例：「西新宿一丁目二番三号」）
3. 町名のみで番地がない住所

#### 完了条件
- すべてのテストがパスすること
- 町名と番地が正しく抽出されること

### ステップ5: その他の要素（建物名・部屋番号など）の抽出機能実装
#### 実装内容
- 残りの部分から建物名や部屋番号を抽出する機能の実装
  - `extract_other` メソッドの実装

#### テストケース
1. 建物名がある住所（例：「〇〇ビル101号室」）
2. 建物名と部屋番号がある住所
3. 建物名や部屋番号がない住所

#### 完了条件
- すべてのテストがパスすること
- 建物名や部屋番号が正しく抽出されること

### ステップ6: 正規化機能の実装
#### 実装内容
- 全角・半角の統一
- 省略形や略称の標準化
- 区切り文字の統一
  - `normalize_address` メソッドの実装

#### テストケース
1. 全角数字を含む住所
2. 半角カタカナを含む住所
3. 異なる区切り文字を含む住所

#### 完了条件
- すべてのテストがパスすること
- 住所が正しく正規化されること

### ステップ7: エッジケースへの対応
#### 実装内容
- 特殊な住所形式への対応
- エラー処理の実装
- 複雑なテストケースの作成と実行

#### テストケース
1. 都道府県名が省略されている住所
2. 特殊な番地表記（丁目、番地、号など漢字表記）
3. 区切り文字が異なる住所（スペース、カンマなど）
4. 全角・半角が混在する住所
5. 住所の一部が欠落している不完全な住所

#### 完了条件
- すべてのテストがパスすること
- エッジケースでも正しく住所が解析されること

### ステップ8: 統合テストと最終調整
#### 実装内容
- すべての機能を統合したテスト
- パフォーマンスの最適化
- ドキュメントの作成

#### テストケース
1. 複数の住所形式を含む統合テスト
2. 大量の住所データを処理するパフォーマンステスト

#### 完了条件
- すべてのテストがパスすること
- ドキュメントが完成していること
- コードが最適化されていること

### ステップ9: 特殊な住所パターンのテスト実装
#### 実装内容
- 日本の住所に存在する特殊なパターンに対応するテストケースの追加
- 必要に応じたパーサーの機能拡張

#### テストケース
1. 都道府県名が2回登場する住所（例：「長野県長野市南長野県町477-1」）
2. 市区町村直下に丁目が存在する住所（例：「静岡県下田市2丁目4-26」）
3. 町名に数字が含まれる住所（例：「埼玉県春日部市八丁目123」）
4. 大字・小字を含む住所（例：「島根県出雲市大社町杵築東宮内195」）
5. 通り名を用いた住所（例：「京都府京都市中京区寺町通御池上ル上本能寺前町488」）
6. 碁盤の目状の住所（例：「北海道札幌市中央区北1条西2丁目5番地」）
7. 丁目の代わりにイロハや甲乙丙を用いる住所（例：「石川県七尾市和倉町ヨ80」）
8. 番地が5桁以上の住所（例：「静岡県浜松市西区篠原町27409」）
9. 町・字が存在しない住所（例：「茨城県龍ケ崎市3710番地」）
10. 日本一長い地名を含む住所（例：「愛知県海部郡飛島村大字飛島新田字竹之郷ヨタレ南之割」）
11. 住居表示未実施区域の住所（例：「東京都千代田区丸の内二丁目7番2号」）
12. 同名の市や町村が存在する住所（例：「東京都府中市」と「広島県府中市」）
13. 無番地の住所（例：「東京都千代田区皇居外苑」）
14. 住居表示と地番が混在する住所（例：「東京都港区赤坂1丁目1番地」と「東京都港区赤坂1-1-1」）
15. 「大字」や「字」の表記が省略される住所（例：「長野県長野市大字長野123」と「長野県長野市長野123」）

#### 実装方針
- 各特殊ケースを個別にテストし、失敗した場合は原因を特定して修正
- 一度に全てのケースを追加するのではなく、一つずつ追加して対応
- 必要に応じてパーサーの機能を拡張

#### 完了条件
- すべての特殊ケースのテストがパスすること
- パーサーが特殊なパターンの住所も正しく解析できること

## 代表的なテストケース

### 基本的なテストケース
1. 「東京都新宿区西新宿1-2-3」
2. 「〒123-4567 東京都新宿区西新宿1-2-3」
3. 「東京都新宿区西新宿1-2-3 〇〇ビル101号室」
4. 「東京都新宿区西新宿一丁目2番3号」

### エッジケース
1. 「新宿区西新宿1-2-3」（都道府県名なし）
2. 「東京新宿区西新宿1-2-3」（都道府県名の省略）
3. 「東京都 新宿区 西新宿 1-2-3」（スペース区切り）
4. 「東京都新宿区西新宿１－２－３」（全角数字）
5. 「東京都新宿区西新宿1丁目2番3号」（漢字と数字の混在）
6. 「東京都新宿区西新宿」（番地なし）
7. 「東京都新宿区西新宿1-2-3 〇〇ビル」（部屋番号なし）

### 特殊な住所パターンのテストケース
1. 「長野県長野市南長野県町477-1」（都道府県名が2回登場）
2. 「静岡県下田市2丁目4-26」（市区町村直下に丁目が存在）
3. 「埼玉県春日部市八丁目123」（町名に数字が含まれる）
4. 「島根県出雲市大社町杵築東宮内195」（大字・小字を含む）
5. 「京都府京都市中京区寺町通御池上ル上本能寺前町488」（通り名を用いた住所）
6. 「北海道札幌市中央区北1条西2丁目5番地」（碁盤の目状の住所）
7. 「石川県七尾市和倉町ヨ80」（丁目の代わりにイロハや甲乙丙を用いる）
8. 「静岡県浜松市西区篠原町27409」（番地が5桁以上）
9. 「茨城県龍ケ崎市3710番地」（町・字が存在しない）
10. 「愛知県海部郡飛島村大字飛島新田字竹之郷ヨタレ南之割」（日本一長い地名）
11. 「東京都千代田区丸の内二丁目7番2号」（住居表示未実施区域）
12. 「東京都府中市」と「広島県府中市」（同名の市や町村）
13. 「東京都千代田区皇居外苑」（無番地）
14. 「東京都港区赤坂1丁目1番地」と「東京都港区赤坂1-1-1」（住居表示と地番の混在）
15. 「長野県長野市大字長野123」と「長野県長野市長野123」（「大字」や「字」の表記が省略）

## 実装詳細

### 使用するライブラリ
- pytest: テスト駆動開発のためのテストフレームワーク
- re: 正規表現を使用した住所解析

### データ構造
住所を以下の構造で表現します：
```python
{
    "prefecture": "都道府県名",
    "city": "市区町村名",
    "town_street": "町名番地",
    "other": "建物名・部屋番号など"
}
```

### 主要な関数
1. `parse_address(address_string)`: 住所文字列を解析して構造化データを返す
2. `extract_prefecture(address_string)`: 都道府県を抽出
3. `extract_city(address_string, prefecture)`: 市区町村を抽出
4. `extract_town_street(address_string, prefecture, city)`: 町名番地を抽出
5. `extract_other(address_string, prefecture, city, town_street)`: その他の要素を抽出
6. `normalize_address(address_dict)`: 抽出した住所を正規化
